﻿@using Umbraco.Cms.Core.Models.Blocks;
@using Umbraco.Cms.Core.Models;
@using Umbraco.Cms.Web.Common
@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Extensions
@using System.Text;
@using Umbraco.Cms.Core.Services
@using Umbraco.Cms.Core.Security
@using Umbraco.Cms.Core;
@using System.Globalization;
@inject IMemberManager MemberManager
@inject IMemberService MemberService
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
	Layout = "~/Views/Shared/_Layout.cshtml";
	var usedCarTitle = Model.Value<string>("usedCarTitle");
	var carCardBlock = Model.Value<IEnumerable<BlockListItem>>("carCardBlock");
	var imgTitle = Model.Value<MediaWithCrops>("image");
	var counter = 1;

	var pageKey = "18ce1861-9a37-4582-8f52-0e866a3ef0de";

	var backofficeUrl = $"/umbraco/backoffice/Kinsen/CarExport/ExportCsv?id={pageKey}";
    var apiUrl        = $"/umbraco/api/CarExport/ExportCsv?id={pageKey}";
	
	// ----------- Μάρκες και Logos------------
	// helper για consistent σύγκριση (αγνοεί κενά/σημεία στίξης, όλα κεφαλαία)
    string Norm(string? s)
        => new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

    // Βρες τον φάκελο Logos στα Media
    var logosFolder = Umbraco.MediaAtRoot()
        .FirstOrDefault(x => x.Name.Equals("Logos", StringComparison.InvariantCultureIgnoreCase));

    // Map: Normalized όνομα → Url εικόνας
    var brandLogos = logosFolder?.Children
        .ToDictionary(m => Norm(m.Name), m => m.Url(), StringComparer.InvariantCulture)
        ?? new Dictionary<string, string>(StringComparer.InvariantCulture);

    // Μάζεψε τις μάρκες από τα blocks
    var brandsRaw = carCardBlock
        .Select(b => b.Content.Value<string>("maker"))
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToList();

    // Original display names (κρατάμε την πρώτη φορά που γράφτηκε)
    var brandDisplayNames = brandsRaw
        .GroupBy(s => Norm(s!))
        .ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

    // Counts ανά μάρκα (δυναμικά)
    var brandCounts = brandsRaw
        .GroupBy(s => Norm(s!))
        .ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

	// Τελική λίστα (normalized keys)
	var comparer = StringComparer.Create(new CultureInfo("el-GR"), true);

	var allBrands = brandDisplayNames
		.OrderBy(kv => kv.Value, comparer)   // kv.Value = displayName
		.Select(kv => kv.Key)                // kv.Key = normalized key (Norm)
		.ToList();

	//----------------Καύσιμο---------------
	string Normalize(string? s)
        => new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

    // Μάζεψε τα καύσιμα από τα blocks
    var fuelRaw = carCardBlock
        .Select(b => b.Content.Value<string>("fuel"))
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToList();

	// Original display names (κρατάμε την πρώτη φορά που γράφτηκε)
    var fuelDisplayNames = fuelRaw
        .GroupBy(s => Normalize(s!))
        .ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

	 // Counts ανά καύσιμο (δυναμικά)
    var fuelCounts = fuelRaw
        .GroupBy(s => Normalize(s!))
        .ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

	// Τελική λίστα (normalized keys)
	var allFuels = fuelDisplayNames
	.OrderBy(kv => kv.Value, comparer)   // kv.Value = π.χ. "Diesel", "Petrol-Hybrid"
	.Select(kv => kv.Key)                // kv.Key = normalized key (π.χ. DIESEL)
	.ToList();


	//------------Κιβώτιο ταχυτήτων----------------
	string Norma(string? s)
        => new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

    // Μάζεψε τα κιβώτια από τα blocks
    var transmissionTypeRaw = carCardBlock
        .Select(b => b.Content.Value<string>("transmissionType"))
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToList();

	// Original display names (κρατάμε την πρώτη φορά που γράφτηκε)
    var transmissionTypelDisplayNames = transmissionTypeRaw
        .GroupBy(s => Norma(s!))
        .ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

	 // Counts ανά κιβώτιο (δυναμικά)
    var transmissionTypeCounts = transmissionTypeRaw
        .GroupBy(s => Norma(s!))
        .ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

	// Τελική λίστα (normalized keys)
	var allTransmissionTypes = transmissionTypelDisplayNames
		.OrderBy(kv => kv.Value, comparer)   // kv.Value = π.χ. "Αυτόματο", "Χειροκίνητο"
		.Select(kv => kv.Key)                // kv.Key = normalized key
		.ToList();

	//----------------------Χρώμα--------------------
	string Normal(string? s)
        => new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

    // Μάζεψε τα χρώματα από τα blocks
    var colorRaw = carCardBlock
        .Select(b => b.Content.Value<string>("color"))
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToList();

	// Original display names (κρατάμε την πρώτη φορά που γράφτηκε)
    var colorNames = colorRaw
        .GroupBy(s => Normal(s!))
        .ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

	 // Counts ανά χρώμα (δυναμικά)
    var colorCounts = colorRaw
        .GroupBy(s => Normal(s!))
        .ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

	// Τελική λίστα (normalized keys)
    var allColors = colorNames
    .OrderBy(kv => kv.Value, comparer)   // kv.Value = "Άσπρο μαύρο μεταλλιζέ" κ.λπ.
    .Select(kv => kv.Key)
    .ToList();


	//--------------------Τύπος Αυτοκινήτου-------------------
	string Normalized(string? s)
		=> new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

	// Μάζεψε τους τύπους από τα blocks
	var typeOfCarRaw = carCardBlock
		.Select(b => b.Content.Value<string>("typeOfCar"))
		.Where(s => !string.IsNullOrWhiteSpace(s))
		.ToList();

	// Original display names
	var typeOfCarNames = typeOfCarRaw
		.GroupBy(s => Normalized(s!))
		.ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

	// Counts
	var typeOfCarCounts = typeOfCarRaw
		.GroupBy(s => Normalized(s!))
		.ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

	// Τελική λίστα
	var allTypeOfCars = typeOfCarCounts.Keys.OrderBy(k => k).ToList();

	//--------------------Προσφορές (Offer Types)-------------------
    string N(string? s)
        => new string((s ?? "").Where(char.IsLetterOrDigit).ToArray()).ToUpperInvariant();

    // Μάζεψε τα Offer Types από τα blocks
    var offerTypeRaw = carCardBlock
        .Select(b => b.Content.Value<string>("typeOfDiscount"))
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToList();

    // Original display names
    var offerTypeNames = offerTypeRaw
        .GroupBy(s => N(s!))
        .ToDictionary(g => g.Key, g => g.First()!, StringComparer.InvariantCulture);

    // Counts
    var offerTypeCounts = offerTypeRaw
        .GroupBy(s => N(s!))
        .ToDictionary(g => g.Key, g => g.Count(), StringComparer.InvariantCulture);

    // Τελική λίστα
    var allOfferTypes = offerTypeCounts.Keys.OrderBy(k => k).ToList();

    var carPages = Model.ChildrenOfType("carPage");

    // Κατάσταση χρήστη
    var isLoggedIn = Context?.User?.Identity?.IsAuthenticated ?? false;

	// Έλεγχος εαν ανήκει στο GroupAdmins που αφορ΄ά το κουμπί Import/Export !!
	var isAdminMember = false;

    if (User?.Identity?.IsAuthenticated ?? false)
    {
        var memberTask = MemberManager.GetCurrentMemberAsync();
        memberTask.Wait();
        var member = memberTask.Result;

        if (member != null)
        {
            var roles = MemberService.GetAllRoles(member.UserName);
            isAdminMember = roles.Contains("GroupAdmins");
        }
    }
}

@* <div class="mt-3" style="display:flex;gap:.5rem;">
  <a class="nx-btn" href="@backofficeUrl" target="_blank" rel="noopener">
    Export cars (Backoffice CSV)
  </a>
  <a class="nx-btn" href="@apiUrl" target="_blank" rel="noopener">
    Export cars (API CSV)
  </a>
</div> *@

@if (isAdminMember)
{
	<a class="btn btn-primary" id="btnExportCars" href="#" role="button">Export Cars</a>

	@* <form id="importForm" enctype="multipart/form-data" method="post" action="/umbraco/api/carimport/upload">
		<h3>📥 Import Cars</h3>
		<input type="file" name="csvFile" id="csvFile" accept=".csv" required />
		<button type="submit" class="btn btn-primary mt-2">Import</button>
		<p id="importMessage" style="margin-top: 10px;"></p>
	</form> *@
}

<div class="usedCars-container">

	<!-- Sidebar Responsive -->
	<div class="filters-container">

		<!-- Κουμπί φιλτρα μόνο σε κινητά -->
		<button class="btn btn-primary btn-filters" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersSidebar">
			<i class="fas fa-filter"></i> Φίλτρα
		</button>

		<!-- Offcanvas (Mobile/Tablet) -->
		<div class="offcanvas offcanvas-start w-100" tabindex="-1" id="filtersSidebar">
			<div class="offcanvas-header">
				@* <h6 class="offcanvas-title" style="color:#007c91;">Φίλτρα</h6> *@
			</div>
			<div class="offcanvas-body">
				<aside class="sidebar">
					<div class="filter-static-header d-flex justify-content-between align-items-center mb-3">
						<h6 class="mb-0 filtra" style="color:#007c91;">Φίλτρα</h6> 
						<button type="button" onclick="clearAllFilters()" class="clear-filters-btn">
							<i class="fa-solid fa-arrows-rotate"></i> Καθαρισμός
						</button>

						<button type="button"
							class="offcanvas-close"
							data-bs-dismiss="offcanvas"
							aria-label="Κλείσιμο">
							<span aria-hidden="true"><i class="fa-solid fa-xmark"></i></span>
						</button>
					</div>
					

					<div class="filter-item">
						<button class="filter-toggle">Τιμή <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
						<div class="filter-content">
							<div class="input-group">
								<label>Από:</label>
								<input type="number" id="minPriceInputMobile"  placeholder="π.χ. 5000" />
								<label>Έως:</label>
								<input type="number" id="maxPriceInputMobile" placeholder="π.χ. 20000" />
							</div>
							<div class="checkbox-columns">
								<div class="checkbox-pair">
									@foreach (var key in allOfferTypes)
									{
										var name = offerTypeNames[key];   // Original display name
										var count = offerTypeCounts[key]; // Count
										<label>
											<input type="checkbox" class="offerTypeCheckbox" value="@name" />
											@name (@count)
										</label>
									}
								</div>

								<div class="price-order-wrapper">
									<select id="priceOrderSelect" class="form-select">
									<option value="asc">Αύξουσα τιμή</option>
									<option value="desc">Φθίνουσα τιμή</option>
									</select>
								</div>
							</div>
						</div>  
					</div>

					<div class="filter-item">
						<button class="filter-toggle">
							Κατασκευαστής <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
						</button>

						<div class="filter-content">
							<div class="twoColumns-grid">
								@foreach (var normBrand in allBrands)
								{
									var displayName = brandDisplayNames[normBrand];
									var count = brandCounts[normBrand];
									//brandLogos.TryGetValue(normBrand, out var logoUrl);

									<label>
										<input type="checkbox" class="brandCheckbox" value="@normBrand" />
										@* @if (!string.IsNullOrWhiteSpace(logoUrl))
										{
											<img src="@logoUrl" alt="@displayName logo" width="20" height="20" />
										} *@
										<span>
											@displayName
											(<span class="brand-count">@count</span>)
										</span>
									</label>
								}
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">Χρονολογία <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
						<div class="filter-content">
							<div class="input-group">
								<label> Από:</label>
								<input type="number"
								id="minYearInputMobile"
								name="minYear"
								min="2000"
								max="@DateTime.Now.Year"
								placeholder="π.χ. 2010" />

								<label>Έως:</label>
								<input type="number"
								id="maxYearInputMobile"
								name="maxYear"
								min="2000"
								max="@DateTime.Now.Year"
								placeholder="π.χ. 2025" />
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">Χιλιόμετρα <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
						<div class="filter-content">
							<div class="input-group">
								<label for="minKlmInput">Από:</label>
								<input type="number"
								id="minKlmInputMobile"
								name="minKm"
								min="0"
								max="200000"
								placeholder="π.χ. 50000" />

								<label for="maxKlmInput">Έως:</label>
								<input type="number"
								id="maxKlmInputMobile"
								name="maxKm"
								min="0"
								max="200000"
								placeholder="π.χ. 150000" />
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">
							Καύσιμο <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
						</button>

						<div class="filter-content">
							<div class="twoColumns-grid">
								@foreach (var normFuel in allFuels)
								{
									var displayNameFuels = fuelDisplayNames[normFuel];
									var countF = fuelCounts[normFuel];

									<label>
										<input type="checkbox" class="fuelCheckbox" value="@normFuel" />
										<span>
											@displayNameFuels
											(<span class="fuel-count">@countF</span>)
										</span>
									</label>
								}
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">Κυβικά (cc) <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
						<div class="filter-content">
							<div class="input-group">
								<label>Από:</label>
								<input type="number" id="minCcInputMobile" name="minCc" min="600" max="6000" placeholder="π.χ. 1400" />
								
								<label>Έως:</label>
								<input type="number" id="maxCcInputMobile" name="maxCc" min="600" max="6000" placeholder="π.χ. 2000" />
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">Ιπποδύναμη (Bhp) <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
						<div class="filter-content">
							<div class="input-group">
								<label>Από:</label>
								<input type="number" id="minHpInputMobile" name="minHp" min="100" max="1000" placeholder="π.χ. 100" />
								
								<label>Έως:</label>
								<input type="number" id="maxHpInputMobile" name="maxHp" min="100" max="1000" placeholder="π.χ. 400" />
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">
							Κιβώτιο Ταχυτήτων <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
						</button>

						<div class="filter-content">
							<div class="twoColumns-grid">
								@foreach (var normTransmission in allTransmissionTypes)
								{
									var displayNameTransmissions = transmissionTypelDisplayNames[normTransmission];
									var countT = transmissionTypeCounts[normTransmission];

									<label>
										<input type="checkbox" class="transmissionCheckbox" value="@normTransmission" />
										<span>
											@displayNameTransmissions
											(<span class="transmission-count">@countT</span>)
										</span>
									</label>
								}
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">
							Χρώμα <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
						</button>

						<div class="filter-content">
							<div class="twoColumns-grid">
								@foreach (var normColor in allColors)
								{
									var displayNameColor = colorNames[normColor];
									var countC = colorCounts[normColor];

									<label>
										<input type="checkbox" class="colorCheckbox" value="@normColor" />
										<span>
											@displayNameColor
											(<span class="color-count">@countC</span>)
										</span>
									</label>
								}
							</div>
						</div>
					</div>

					<div class="filter-item">
						<button class="filter-toggle">
							Τύπος Αυτοκινήτου <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
						</button>

						<div class="filter-content">
							<div class="twoColumns-grid">
								@foreach (var normType in allTypeOfCars)
								{
									var displayNameType = typeOfCarNames[normType];
									var countType = typeOfCarCounts[normType];

									<label>
										<input type="checkbox" class="carTypeCheckbox" value="@normType" />
										<span>
											@displayNameType
											(<span class="carType-count">@countType</span>)
										</span>
									</label>
								}
							</div>
						</div>
					</div>

				</aside>
			</div>
		</div>

		<!----- Sidebar σταθερό (Desktop) --------------->
		<aside class="sidebar d-none d-lg-block">
			<div class="filter-static-header d-flex justify-content-between align-items-center mb-3">
				<h5 class="mb-0" style="color:#007c91;"><i class="fas fa-filter"></i>Φίλτρα</h5>
				<button onclick="clearAllFilters()" class="clear-filters-btn">
					<i class="fa-solid fa-arrows-rotate"></i> Καθαρισμός
				</button>
			</div>
			
			<div class="filter-item">
				<button class="filter-toggle">Τιμή <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
				<div class="filter-content">
					<div class="input-group">
						<label>Από:</label>
						<input type="number" id="minPriceInputDesk" placeholder="π.χ. 5000" />
						<label>Έως:</label>
						<input type="number" id="maxPriceInputDesk" placeholder="π.χ. 20000" />
					</div>
					<div class="checkbox-columns">
						<div class="checkbox-pair">
							@foreach (var key in allOfferTypes)
							{
								var name = offerTypeNames[key];   // Original display name
								var count = offerTypeCounts[key]; // Count
								<label>
									<input type="checkbox" class="offerTypeCheckbox" value="@name" />
									@name (@count)
								</label>
							}
						</div>

						<div class="price-order-wrapper">
							<select id="priceOrderSelect" class="form-select">
							<option value="asc">Αύξουσα τιμή</option>
							<option value="desc">Φθίνουσα τιμή</option>
							</select>
						</div>
					</div>
				</div>  
			</div>

			<div class="filter-item">
				<button class="filter-toggle">
					Κατασκευαστής <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
				</button>

				<div class="filter-content">
					<div class="twoColumns-grid">
						@foreach (var normBrand in allBrands)
						{
							var displayName = brandDisplayNames[normBrand];
							var count = brandCounts[normBrand];
							//brandLogos.TryGetValue(normBrand, out var logoUrl);

							<label>
								<input type="checkbox" class="brandCheckbox" value="@normBrand" />
								@* @if (!string.IsNullOrWhiteSpace(logoUrl))
								{
									<img src="@logoUrl" alt="@displayName logo" width="20" height="20" />
								} *@
								<span>
									@displayName
									(<span class="brand-count">@count</span>)
								</span>
							</label>
						}
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">Χρονολογία <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
				<div class="filter-content">
					<div class="input-group">
						<label> Από:</label>
						<input type="number"
						id="minYearInputDesk"
						name="minYear"
						min="2000"
						max="@DateTime.Now.Year"
						placeholder="π.χ. 2010" />

						<label>Έως:</label>
						<input type="number"
						id="maxYearInputDesk"
						name="maxYear"
						min="2000"
						max="@DateTime.Now.Year"
						placeholder="π.χ. 2025" />
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">Χιλιόμετρα <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
				<div class="filter-content">
					<div class="input-group">
						<label for="minKlmInput">Από:</label>
						<input type="number"
						id="minKlmInputDesk"
						name="minKm"
						min="0"
						max="200000"
						placeholder="π.χ. 50000" />

						<label for="maxKlmInput">Έως:</label>
						<input type="number"
						id="maxKlmInputDesk"
						name="maxKm"
						min="0"
						max="200000"
						placeholder="π.χ. 150000" />
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">
					Καύσιμο <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
				</button>

				<div class="filter-content">
					<div class="twoColumns-grid">
						@foreach (var normFuel in allFuels)
						{
							var displayNameFuels = fuelDisplayNames[normFuel];
							var countF = fuelCounts[normFuel];

							<label>
								<input type="checkbox" class="fuelCheckbox" value="@normFuel" />
								<span>
									@displayNameFuels
									(<span class="fuel-count">@countF</span>)
								</span>
							</label>
						}
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">Κυβικά (cc) <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
				<div class="filter-content">
					<div class="input-group">
						<label>Από:</label>
						<input type="number" id="minCcInputDesk" name="minCc" min="600" max="6000" placeholder="π.χ. 1400" />
						
						<label>Έως:</label>
						<input type="number" id="maxCcInputDesk" name="maxCc" min="600" max="6000" placeholder="π.χ. 2000" />
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">Ιπποδύναμη (Bhp) <span class="icon"><i class="fa-solid fa-chevron-down"></i></span></button>
				<div class="filter-content">
					<div class="input-group">
						<label>Από:</label>
						<input type="number" id="minHpInputDesk" name="minHp" min="100" max="1000" placeholder="π.χ. 100" />
						
						<label>Έως:</label>
						<input type="number" id="maxHpInputDesk" name="maxHp" min="100" max="1000" placeholder="π.χ. 400" />
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">
					Κιβώτιο Ταχυτήτων <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
				</button>

				<div class="filter-content">
					<div class="twoColumns-grid">
						@foreach (var normTransmission in allTransmissionTypes)
						{
							var displayNameTransmissions = transmissionTypelDisplayNames[normTransmission];
							var countT = transmissionTypeCounts[normTransmission];

							<label>
								<input type="checkbox" class="transmissionCheckbox" value="@normTransmission" />
								<span>
									@displayNameTransmissions
									(<span class="transmission-count">@countT</span>)
								</span>
							</label>
						}
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">
					Χρώμα <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
				</button>

				<div class="filter-content">
					<div class="twoColumns-grid">
						@foreach (var normColor in allColors)
						{
							var displayNameColor = colorNames[normColor];
							var countC = colorCounts[normColor];

							<label>
								<input type="checkbox" class="colorCheckbox" value="@normColor" />
								<span>
									@displayNameColor
									(<span class="color-count">@countC</span>)
								</span>
							</label>
						}
					</div>
				</div>
			</div>

			<div class="filter-item">
				<button class="filter-toggle">
					Τύπος Αυτοκινήτου <span class="icon"><i class="fa-solid fa-chevron-down"></i></span>
				</button>

				<div class="filter-content">
					<div class="twoColumns-grid">
						@foreach (var normType in allTypeOfCars)
						{
							var displayNameType = typeOfCarNames[normType];
							var countType = typeOfCarCounts[normType];

							<label>
								<input type="checkbox" class="carTypeCheckbox" value="@normType" />
								<span>
									@displayNameType
									(<span class="carType-count">@countType</span>)
								</span>
							</label>
						}
					</div>
				</div>
			</div>
		</aside>
	</div> 

    <div class="carsAndPaginationOUTER">
		<div class="carsAndPagination">
			<div id="displayCars" class="displayCars">
    			<div id="noResultsBox">
					<div class="card-header">
						<div class="no-results__icon" aria-hidden="true">
						<i class="fa-solid fa-magnifying-glass"></i>
						</div>
						<h5 class="card-title no-results__title">Δεν βρέθηκαν οχήματα</h5>
						<p class="card-text no-results__hint">
						Δοκίμασε να αλλάξεις τα φίλτρα ή καθάρισέ τα για να δεις όλα τα αποτελέσματα.
						</p>
						<div class="no-results__actions">
							<button type="button" class="nr-btn" onclick="clearAllFilters()">
								<i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
								Καθαρισμός φίλτρων
							</button>
						</div>
					</div>
				</div>

				@* <div class="card-body"> *@
					
					@if (carCardBlock != null)
					{
						var validCards = carCardBlock
						.Where(b =>
						{
							var c = b.Content;
							string T(string a) => (c.Value<string>(a) ?? "").Trim();

							var model = T("model");

							var hasModel = !string.IsNullOrWhiteSpace(model);
							return hasModel;
						})
						.ToList();

						@foreach (var card in validCards)
						{
							var car = card.Content;
							var carID = car.Value<string>("carID");
							var carPic = car.Value<MediaWithCrops>("carPic");
							var maker = car.Value<string>("maker");
							var modelo = car.Value<string>("model");
							var yearRelease = car.Value<string>("yearRelease");
							var price = car.Value<string>("price");
							var km = car.Value<string>("km");
							var cc = car.Value<string>("cc");
							var hp = car.Value<string>("hp");
							var typeOfDiscount = car.Value<string>("typeOfDiscount");
							var typeOfFuel = car.Value<string>("fuel");
							var transmission = car.Value<string>("transmissionType");
							var color = car.Value<string>("color");
							var typeOfCar = car.Value<string>("typeOfCar");
							
							<div class="cardCar" data-id="@carID" data-offer-type="@typeOfDiscount?.ToLowerInvariant()">
								<a href="/carDetails/"
									class="cardCarLink" 
									data-car-id="@carID" 
									onclick="storeCarId(event, '@carID')"
									style="text-decoration: none; color: inherit;">
								
									@if (!string.IsNullOrWhiteSpace(typeOfDiscount))
									{
										<span class="discount-badge">@typeOfDiscount</span>
									}

									<img src="@carPic?.Url()" class="card-img-top car-image" />
									<div class="card-body d-flex flex-column justify-content-between text-center p-3">
										<div>
											<h4 class="maker-title fw-semibold mb-2">@maker <span class="card-title">@modelo</span></h4>
											<p class="car-year">@yearRelease</p>
											<p class="card-text fw-bold mb-1" style="font-size: 1.25rem;">@price €</p>
											<p class="text-muted mb-0">
												<i class="fa-solid fa-road"></i><span class="klm">&nbsp; @km </span>km &nbsp;&nbsp;
												<i class="fa fa-wrench"></i><span class="cc">&nbsp; @cc</span>cc &nbsp;&nbsp;
												<i class="fa-solid fa-gas-pump"></i><span class="fuel">&nbsp; @typeOfFuel</span>
											</p>
											<p class="transmission" style="display:none">@transmission</p>
											<p class="typeOfColor" style="display:none">@color</p>
											<p class="hp" style="display:none">@hp</p>
											<p class="typeOfCar" style="display:none">@typeOfCar</p>
										</div>
									</div>
								</a>
							</div>
						}
					}
				@* </div> *@
			</div>
			<div class="pagination-wrapper">
				<nav class="mt-4 w-100">
					<div id="paginationControls" class="pagination justify-content-center flex-wrap"></div>
				</nav>
			</div>
		</div>
	</div>
</div>

<script>
(function(){
  var el = document.getElementById('filtersSidebar');
  var btn = el && el.querySelector('.offcanvas-close');
  if(!el || !btn) return;
  btn.addEventListener('click', function(){
    var inst = window.bootstrap && bootstrap.Offcanvas
      ? bootstrap.Offcanvas.getOrCreateInstance(el) : null;
    if(inst) inst.hide(); else el.classList.remove('show');
  });
})();
</script>

@* Αφορ΄ά το Export: *@
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const exportBtn = document.getElementById("btnExportCars");

        if (exportBtn) {
            exportBtn.addEventListener("click", function () {
                const cars = document.querySelectorAll(".cardCar");

                if (cars.length === 0) {
                    alert("Δεν υπάρχουν αυτοκίνητα για export.");
                    return;
                }

                const headers = [
                    "ID", "Maker", "Model", "Year", "Price", "KM", "CC", "HP",
                    "Fuel", "Transmission", "Color", "TypeOfCar", "OfferType"
                ];

                const escapeCSV = (text) => {
                    if (!text) return "";
                    const escaped = text.replace(/"/g, '""');
                    return `"${escaped}"`;
                };

                const delimiter = ";"; // 👈 Εδώ αλλάζεις το delimiter

                let csvRows = [];
                csvRows.push(headers.map(escapeCSV).join(delimiter)); // Header row

                cars.forEach(car => {
                    const getText = (selector) => {
                        const el = car.querySelector(selector);
                        return el ? el.textContent.trim() : "";
                    };

                    const row = [
                        car.getAttribute("data-id"),
                        getText(".maker-title"),
                        getText(".card-title"),
                        getText(".car-year"),
                        getText(".card-text"),
                        getText(".klm"),
                        getText(".cc"),
                        getText(".hp"),
                        getText(".fuel"),
                        getText(".transmission"),
                        getText(".typeOfColor"),
                        getText(".typeOfCar"),
                        car.getAttribute("data-offer-type")
                    ].map(escapeCSV);

                    csvRows.push(row.join(delimiter));
                });

                const csvContent = "\uFEFF" + csvRows.join("\n"); // UTF-8 BOM

                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", "cars-export.csv");
                link.click();
            });
        }
    });
</script>

@* Αφορ΄ά το Import: *@
@* <script>
    document.getElementById("importForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const fileInput = document.getElementById("csvFile");
        const formData = new FormData();
        formData.append("csvFile", fileInput.files[0]);

        fetch("/umbraco/api/carimport/upload", {
            method: "POST",
            body: formData
        })
        .then(r => r.text())
        .then(res => {
            document.getElementById("importMessage").textContent = res;
        })
        .catch(err => {
            console.error(err);
            document.getElementById("importMessage").textContent = "❌ Σφάλμα κατά το import.";
        });
    });
</script> *@

<script>
// -------- ΒΟΗΘΗΤΙΚΑ --------
/* function storeCarId(e, carId) {
  // γράφουμε το id πριν το navigation
  const id = Number(carId);
  if (!Number.isFinite(id) || id <= 0) return true;
  try {
    sessionStorage.setItem('selectedCarId', String(id));
    if (carObj) sessionStorage.setItem(`car:${id}`, JSON.stringify(carObj));
    window.name = 'car:' + id;
  } catch {}
  return true;
}

function createCarCard(car) {
  // car = { id, maker, model, yearRelease, price, km, cc, hp, typeOfDiscount, fuel, transmissionType, color, typeOfCar, carPicUrl }
  const card = document.createElement('div');
  const id = Number(car?.id ?? car?.Id);
  const safeId = Number.isFinite(id) ? id : 0;
  card.className = 'cardCar';
  if (safeId) card.setAttribute('data-id', String(safeId));


  const href = '/carDetails/';
  card.innerHTML = `
    <a href="${href}" class="cardCarLink" onclick="return storeCarId(event, ${Number(car?.id ?? car?.Id) || 0})" style="text-decoration:none;color:inherit;">
      ${car.typeOfDiscount ? `<span class="discount-badge">${car.typeOfDiscount}</span>` : ``}
      <img src="${car.carPicUrl || ''}" class="card-img-top car-image"
     onerror="if (!this.dataset.fallback){ this.dataset.fallback=1; this.src='/media/no-image.png'; }" />
      <div class="card-body d-flex flex-column justify-content-between text-center p-3">
        <div>
          <h4 class="maker-title fw-semibold mb-2">${car.maker ?? ''} <span class="card-title">${car.model ?? ''}</span></h4>
          <p class="car-year">${car.yearRelease ?? ''}</p>
          <p class="card-text fw-bold mb-1" style="font-size:1.25rem;">${car.price ?? ''} €</p>
          <p class="text-muted mb-0">
            <i class="fa-solid fa-road"></i><span class="klm">&nbsp; ${car.km ?? ''} </span>km &nbsp;&nbsp;
            <i class="fa fa-wrench"></i><span class="cc">&nbsp; ${car.cc ?? ''}</span>cc &nbsp;&nbsp;
            <i class="fa-solid fa-gas-pump"></i><span class="fuel">&nbsp; ${car.fuel ?? ''}</span>
          </p>
          <p class="transmission" style="display:none">${car.transmissionType ?? ''}</p>
          <p class="typeOfColor" style="display:none">${car.color ?? ''}</p>
          <p class="hp" style="display:none">${car.hp ?? ''}</p>
          <p class="typeOfCar" style="display:none">${car.typeOfCar ?? ''}</p>
        </div>
      </div>
    </a>
  `;
  return card;
}

async function loadCars() {
  const container = document.getElementById('displayCars');
  const emptyBox  = document.getElementById('noResultsBox');

  // Προαιρετικό: loading state
  container.classList.add('loading');

  try {
    const resp = await fetch('/umbraco/api/carstock/displayCars', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({}) 
    });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`Server ${resp.status}: ${txt}`);
    }
    console.log('[displayCars] status', resp.status);
	const cars = await resp.json();
	console.log('[displayCars] payload', cars);

    // Καθάρισε προηγούμενα (εκτός από το noResultsBox)
    [...container.querySelectorAll('.cardCar')].forEach(n => n.remove());

    if (!cars || !cars.length) {
      emptyBox.style.display = '';
      return;
    }
    emptyBox.style.display = 'none';

    const frag = document.createDocumentFragment();
    cars.forEach(car => frag.appendChild(createCarCard(car)));
    container.appendChild(frag);
  } catch (err) {
    console.error('loadCars error:', err);
    emptyBox.style.display = '';
  } finally {
    container.classList.remove('loading');
  }
}

document.addEventListener('DOMContentLoaded', loadCars); */
</script>



<script src="~/js/usedCarSalesFilters.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>