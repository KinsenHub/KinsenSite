@using Umbraco.Cms.Web.Common.PublishedModels;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject Umbraco.Cms.Web.Common.UmbracoHelper UmbracoHelper
@{
	Layout = "~/Views/Shared/_Layout.cshtml";
	ViewData["Title"] = "Τα αγαπημένα σου | kinsen.gr";
  var usedPage = UmbracoHelper.ContentAtRoot()
        .SelectMany(x => x.DescendantsOrSelf())
        .FirstOrDefault(x => x.ContentType.Alias == "usedCarSalesPage");

  var usedUrl = usedPage?.Url() ?? "/πωλήσεις-μεταχειρισμένων/";
	var favTitle = Model.Value<string>("favTitle");
}

<h1 id="favTitle" class="favTitle">@favTitle</h1>
<div class="favorites-page">
  <div id="favoritesList" class="favorites-grid"></div>
</div>

<script>

function formatGreekThousands(value) {
  if (value == null) return "";

  // κράτα μόνο ψηφία (βγάζει €, τελείες, κόμματα κλπ)
  const digits = String(value).replace(/[^\d]/g, "");
  if (!digits) return String(value);

  const n = Number(digits);
  if (!Number.isFinite(n)) return String(value);

  // el-GR βάζει τελεία στις χιλιάδες
  return n.toLocaleString("el-GR");
}

document.addEventListener("DOMContentLoaded", async () => {
  const containerFavorites = document.getElementById("favoritesList");
  if (!containerFavorites) return;

  try {
    const r = await fetch("/umbraco/api/favorites/get", {
      credentials: "same-origin",
    });

    if (!r.ok) throw new Error(await r.text());

    const cars = await r.json();

    if (!cars.length) {
      document.getElementById("favTitle")?.remove(); 
      containerFavorites.innerHTML = renderEmptyFavorites();
      return;
    }

    containerFavorites.innerHTML = cars
    .map( (c) => `
      <div class="favorite-card" data-id="${c.id}">
        
        <button class="favorite-btn" data-car-id="${
          c.id
        }" title="Αφαίρεση από αγαπημένα">
          <i class="fa-solid fa-heart"></i>
        </button>

        <a href="${c.url}" style="text-decoration:none;color:inherit;">
          <img src="${c.img || "/images/no-image.png"}" alt="">
          <div class="favorite-title">${c.maker} ${c.model}</div>
          <div class="favorite-year">${c.year ?? ""}</div>
          <div class="favorite-price">${formatGreekThousands(c.price)} €</div>
        </a>

      </div>
    `).join("");

  } catch (err) {
    console.error("Favorites load error:", err);
    containerFavorites.innerHTML = "<p>Σφάλμα φόρτωσης αγαπημένων.</p>";
  }
});

// ❤️ Αφαίρεση από αγαπημένα
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".favorite-btn");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const carId = btn.dataset.carId;

  try {
    const r = await fetch("/umbraco/api/favorites/toggle", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ carId: Number(carId) }),
    });

    if (!r.ok) throw new Error(await r.text());

    const { isFavorite } = await r.json();

    // αν αφαιρέθηκε → βγάλ’ το από το grid
   if (!isFavorite) {
      const card = btn.closest(".favorite-card");
      card?.remove();

      // ✅ ΠΑΡΕ ΤΟ CONTAINER ΕΔΩ (σωστό scope)
      const containerFavorites = document.getElementById("favoritesList");

      if (
        containerFavorites &&
        !containerFavorites.querySelector(".favorite-card")
      ) {
        document.getElementById("favTitle")?.remove(); 
        containerFavorites.innerHTML = renderEmptyFavorites();
      }
    }
  } catch (err) {
    console.error("Favorite toggle error:", err);
  }
});

// Εμφάνιση μηνύματος όταν τα αγαπημένα είναι ΑΔΕΙΑ!
function renderEmptyFavorites() {
  return `
    <div class="favorites-empty">
      <div class="favorites-empty-icon" aria-hidden="true">
        <i class="fa-regular fa-heart"></i>
      </div>

      <h2 class="favorites-empty-title">Δεν έχετε αγαπημένα</h2>
      <p class="favorites-empty-text">
        Προσθέστε αυτοκίνητα στα αγαπημένα για να τα βρείτε εδώ.
      </p>

      <a href="@usedUrl" class="favorites-empty-btn">Πίσω στα αυτοκίνητα</a>
    </div>
  `;
}
</script>

