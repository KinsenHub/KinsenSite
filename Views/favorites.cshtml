@using Umbraco.Cms.Web.Common.PublishedModels
@using Umbraco.Cms.Core.Models.PublishedContent
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject Umbraco.Cms.Web.Common.UmbracoHelper UmbracoHelper
@{
	Layout = "~/Views/Shared/_Layout.cshtml";
	ViewData["Title"] = "Τα αγαπημένα σου | kinsen.gr";
  var usedPage = UmbracoHelper.ContentAtRoot()
        .SelectMany(x => x.DescendantsOrSelf())
        .FirstOrDefault(x => x.ContentType.Alias == "usedCarSalesPage");

  var usedUrl = usedPage?.Url() ?? "/πωλήσεις-μεταχειρισμένων/";
	var favTitle = Model.Value<string>("favTitle");
  var noImgUrl = Model.Value<IPublishedContent>("noImgAvail")?.Url();
}

<h1 id="favTitle" class="favTitle">@favTitle</h1>
<div class="favorites-page">
  <div id="favoritesList" class="favorites-grid"></div>
  <div id="favoritesEmpty" class="favorites-empty" style="display:none;"></div>
</div>

<script>

function formatGreekThousands(value) {
  if (value == null) return "";

  // κράτα μόνο ψηφία (βγάζει €, τελείες, κόμματα κλπ)
  const digits = String(value).replace(/[^\d]/g, "");
  if (!digits) return String(value);

  const n = Number(digits);
  if (!Number.isFinite(n)) return String(value);

  // el-GR βάζει τελεία στις χιλιάδες
  return n.toLocaleString("el-GR");
}

// Εμφάνιση μηνύματος όταν τα αγαπημένα είναι ΑΔΕΙΑ!
function renderEmptyFavorites() {
  return `
    <div class="favorites-empty-icon" aria-hidden="true">
      <i class="fa-regular fa-heart"></i>
    </div>

    <h2 class="favorites-empty-title">Δεν έχετε αγαπημένα</h2>
    <p class="favorites-empty-text">
      Προσθέστε αυτοκίνητα στα αγαπημένα για να τα βρείτε εδώ.
    </p>

    <a href="@usedUrl" class="favorites-empty-btn">Πίσω στα αυτοκίνητα</a>
  `;
}

function showEmptyState() {
  const grid = document.getElementById("favoritesList");
  const emptyBox = document.getElementById("favoritesEmpty");
  const title = document.getElementById("favTitle");

  if (!grid || !emptyBox) return;

  title?.remove();
  grid.style.display = "none";
  emptyBox.style.display = "flex";
  emptyBox.innerHTML = renderEmptyFavorites();
}

function showGridState() {
  const grid = document.getElementById("favoritesList");
  const emptyBox = document.getElementById("favoritesEmpty");

  if (!grid || !emptyBox) return;

  emptyBox.style.display = "none";
  emptyBox.innerHTML = "";
  grid.style.display = "";
}

async function loadFavorites() {
  const grid = document.getElementById("favoritesList");
  if (!grid) return;

  try {
    const r = await fetch("/umbraco/api/favorites/get", { credentials: "same-origin" });
    if (!r.ok) throw new Error(await r.text());

    const cars = await r.json();

    if (!cars.length) {
      showEmptyState();
      return;
    }

    showGridState();

    grid.innerHTML = cars.map(c => `
      <div class="favorite-card" data-id="${c.id}">
        <button class="favorite-btn" data-car-id="${c.id}" title="Αφαίρεση από αγαπημένα">
          <i class="fa-solid fa-heart"></i>
        </button>

        <a href="${c.url}" style="text-decoration:none;color:inherit;">
          <img
            src="${(c.img && String(c.img).trim()) ? c.img : '@noImgUrl'}"
            alt=""
            onerror="this.onerror=null;this.src='@noImgUrl';">
          <div class="favorite-title">${c.maker} ${c.model}</div>
          <div class="favorite-year">${c.year ?? ""}</div>
          <div class="favorite-price">${formatGreekThousands(c.price)} €</div>
        </a>
      </div>
    `).join("");

  } catch (err) {
    console.error("Favorites load error:", err);
    grid.innerHTML = "<p>Σφάλμα φόρτωσης αγαπημένων.</p>";
  }
}

document.addEventListener("DOMContentLoaded", loadFavorites);

// ❤️ Toggle / Remove
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".favorite-btn");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const carId = Number(btn.dataset.carId);
  if (!carId) return;

  try {
    const r = await fetch("/umbraco/api/favorites/toggle", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ carId }),
    });

    if (!r.ok) throw new Error(await r.text());

    const { isFavorite } = await r.json();

    // αν αφαιρέθηκε από favorites page -> remove card
    if (!isFavorite) {
      btn.closest(".favorite-card")?.remove();

      const grid = document.getElementById("favoritesList");
      if (grid && !grid.querySelector(".favorite-card")) {
        showEmptyState(); // ✅ εδώ θα φύγει ΚΑΙ ο τίτλος
      }
    }

  } catch (err) {
    console.error("Favorite toggle error:", err);
  }
});
 
</script>

