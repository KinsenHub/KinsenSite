@using Umbraco.Cms.Core.Models.Blocks;
@using Umbraco.Cms.Core.Models; 
@using Umbraco.Cms.Web.Common.PublishedModels
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
	ViewData["Title"] = "Λεπτομέρειες οχήματος | kinsen.gr";
    var url = Context.Request.Path.Value; 
    var segments = url.Split('/', StringSplitOptions.RemoveEmptyEntries);
    var carID = Context.Request.Query["id"].ToString();
	var noImgUrl = Model.Value<IPublishedContent>("imgNotAvail")?.Url();

	// Κατάσταση χρήστη
    var isLoggedIn = Context?.User?.Identity?.IsAuthenticated ?? false;
}

<div id="carDetailsContainer">

	<script>
		(() => {

		const url = new URL(window.location.href);
		const queryId = url.searchParams.get("id");

		if (queryId) {
			try { sessionStorage.setItem("selectedCarId", queryId); } catch {}
			// Καθάρισε το URL χωρίς reload
			url.searchParams.delete("id");
			window.history.replaceState({ carId: queryId }, "", url.toString());
		}

		// helper: διάβασε cookie
		function getCookie(name) {
			const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-[\]{}()*+?.,\\^$|#\\s]/g,'\\$&') + '=([^;]*)'));
			return m ? decodeURIComponent(m[1]) : null;
		}

		const fromStorage = sessionStorage.getItem('selectedCarId');
		const fromState   = (history.state && history.state.carId) ? String(history.state.carId) : null;
		const fromCookie  = getCookie('selectedCarId');
		let   fromName    = null;
		if (typeof window.name === 'string' && window.name.indexOf('car:') === 0) {
   			fromName = window.name.slice(4); // πάρε ΜΟΝΟ το ID
 		}
		const carID = (fromStorage && fromStorage.trim())
					|| (fromState && fromState.trim())
					|| (fromCookie && fromCookie.trim())
					|| (fromName && fromName.trim());

		console.log('[MEMBER] carID (resolved):', carID);

		if (!carID) {
			console.warn('[MEMBER] carID is missing or empty');
			// προαιρετικά: window.location.href = '/cars';
			return;
		}

		// Αν ο controller σου θέλει int, κράτα αυτόν τον έλεγχο:
		if (!/^\d+$/.test(carID)) {
			console.error('[MEMBER] carID is not numeric, controller expects int:', carID);
			return;
		}

		// ------- rehydrate για να επιβιώνει σε refresh/επιστροφές -------
		if (!fromStorage && (fromCookie || fromName)) {
			try { sessionStorage.setItem('selectedCarId', carID); } catch {}
		}
		if (!fromCookie) {
			document.cookie = `selectedCarId=${encodeURIComponent(carID)}; Max-Age=${30*60}; Path=/; SameSite=Lax; Secure`;
		}
		if (!fromName) {
			window.name = 'car:' + carID;
		}
		history.replaceState({ carId: carID }, '', location.pathname);

		console.log("carID from Razor:", carID); 

		@* const payload = { id: Number(carID) };  *@
		fetch("/umbraco/api/CarApiMember/getcarbyid", {
			method: "POST",
			headers: {"Content-Type": "application/json"},
			credentials: "same-origin",
  			body: JSON.stringify({ id: parseInt(carID, 10) }) 
		})
			.then(async (resp) => {
				const text = await resp.text();
				if (!resp.ok) {
					let msg = text;
					try { msg = JSON.parse(text).message || msg; } catch {}
					throw new Error(`API ${resp.status} - ${msg}`);
				}
				return text ? JSON.parse(text) : null;
			})
			
			.then(data => {
				console.log("API RESPONSE:", data);
				
				try { sessionStorage.setItem('selectedCarId', carID); } catch {}
					document.cookie = `selectedCarId=${encodeURIComponent(carID)}; Max-Age=${30*60}; Path=/; SameSite=Lax; Secure`;
					window.name = 'car:' + carID;
					const formattedPrice = Number(data.price).toLocaleString('el-GR');

					const mainImage = (data.imageUrl && data.imageUrl.trim()) ? data.imageUrl : '@noImgUrl';

					const galleryImages = Array.isArray(data.gallery) ? data.gallery.filter(img => img && img !== mainImage) : [];

					let indicatorsHtml = `
					<button type="button"
							data-bs-target="#carouselExampleDark"
							data-bs-slide-to="0"
							class="active"
							aria-current="true"
							aria-label="Slide 1"></button>
					`;

					let slidesHtml = `
					<div class="carousel-item active">
						<img
						src="${mainImage}"
						class="d-block mx-auto"
						style="max-width:500px;max-height:450px;width:auto;"
						alt="Car Image"
						onerror="this.onerror=null;this.src='@noImgUrl';"
						/>
					</div>
					`;

					galleryImages.forEach((img, index) => {
					indicatorsHtml += `
						<button type="button"
								data-bs-target="#carouselExampleDark"
								data-bs-slide-to="${index + 1}"
								aria-label="Slide ${index + 2}"></button>
					`;

					slidesHtml += `
						<div class="carousel-item">
						<img
							src="${img}"
							class="d-block mx-auto"
							style="max-width:500px;max-height:450px;width:auto;"
							alt="Car Image"
							onerror="this.onerror=null;this.src='@noImgUrl';"
						/>
						</div>
					`;
					});

					document.getElementById('carDetailsContainer').innerHTML = `	
					<div class="w-100 mt-5 d-flex justify-content-center">
						<div id="carouselExampleDark"
							class="carousel carousel-dark slide shadow-lg custom-carousel"
							data-bs-ride="carousel">

							<div class="carousel-indicators">
							${indicatorsHtml}
							</div>

							<div class="carousel-inner">
							${slidesHtml}
							</div>

							<button class="carousel-control-prev"
									type="button"
									data-bs-target="#carouselExampleDark"
									data-bs-slide="prev">
							<span class="carousel-control-prev-icon"></span>
							</button>

							<button class="carousel-control-next"
									type="button"
									data-bs-target="#carouselExampleDark"
									data-bs-slide="next">
							<span class="carousel-control-next-icon"></span>
							</button>
						</div>
					</div>

					<div class="offer-box">
						<div class="price-section">
						<span class="car-title">${data.maker} ${data.model}<br></span>
							<span class="price-label">Τιμή αγοράς:</span>
							<span class="price-value">${formattedPrice} €</span>
							<span class="vat-label">με τον ΦΠΑ</span>
						</div>
						<div class="prokatavoli_label">Προκαταβολή (€):</div>
						<input
							type="text"
							class="form-control"
							id="inputProkatavoli"
							name="prokatavoli"
							inputmode="numeric"
							maxlength="5"
							pattern="^[1-9]\d{2,4}$"
							placeholder="π.χ. 100"
							required
							oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,5);"
						/>
						<div class="upologismos_label">Υπολογισμός σε Δόσεις:</div>
							<div class="btn-group">
								<button class="custom-dropdown-button dropdown-toggle"
									type="button"
									data-bs-toggle="dropdown"
									aria-expanded="false"
									data-plan="efapaks">
									Εφάπαξ χωρίς Τόκους
								</button>
								<ul class="dropdown-menu">
									<li><button class="dropdown-item" type="button" value="efapaks">Εφάπαξ χωρίς Τόκους</button></li>
									<li><button class="dropdown-item" type="button" value="6">6 Μήνες</button></li>
									<li><button class="dropdown-item" type="button" value="12">12 Μήνες</button></li>
									<li><button class="dropdown-item" type="button" value="24">24 Μήνες</button></li>
									<li><button class="dropdown-item" type="button" value="36">36 Μήνες</button></li>
									<li><button class="dropdown-item" type="button" value="48">48 Μήνες</button></li>
								</ul>
							</div>
							<div class="installment-result">
								Μηνιαία Δόση: <span id="installmentValue">-</span>
							</div>
							<div class="offer-button-container">	
								<button class="addToCartBtn"> Προσθήκη στο Καλάθι </button>
							</div>
							<div
							id="cartMsg"
							class="cartMsg d-flex justify-content-center mt-3"
							aria-live="polite"
							></div>
						</div>
					
					<section class="car-specs-section">
						<p>Στοιχεία αυτοκινήτου</p>
						<div class="specs-grid">
							<div><strong>Μάρκα:&nbsp;</strong> ${data.maker}</div>
							<div><strong>Μοντέλο:&nbsp;</strong> ${data.model}</div>
							<div><strong>Κατηγορία:&nbsp;</strong> ${data.typeOfCar}</div>
							<div><strong>Χρώμα:&nbsp;</strong> ${data.color}</div>
							<div><strong>Καύσιμο:&nbsp;</strong> ${data.fuel}</div>
							<div><strong>Κιβώτιο:&nbsp;</strong> ${data.transmissionType}</div>
							<div><strong>Χιλιόμετρα:&nbsp;</strong> ${data.km} km</div>
							<div><strong>Ιπποδύναμη:&nbsp;</strong> ${data.hp} hp</div>
							<div><strong>Κυβικά:&nbsp;</strong> ${data.cc} cc</div>
						</div>
					</section>
				`; 
			})
			.catch(error => {
				console.error("API ERROR:", error); 
			});
			window.addEventListener('pageshow', evt => {
			const nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
			const isBF = (evt.persisted === true) || (nav && nav.type === 'back_forward');
		});
	})();
		
	</script>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/carDetailsMember.js"></script>

<script>
	document.addEventListener('click', (e) => {
		const toggleBtn = e.target.closest('.custom-dropdown-button');
		const item = e.target.closest('.dropdown-item');
		const clickedInsideDropdown = e.target.closest('.btn-group');

		// ΤΟGGLE: Άνοιγμα / κλείσιμο dropdown όταν πατηθεί το κουμπί
		if (toggleBtn) {
			e.preventDefault();

			const dropdownMenu = toggleBtn.nextElementSibling;
			if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
				dropdownMenu.classList.toggle('show');
			}
			return;
		}

		// ΕΠΙΛΟΓΗ item: ενημέρωση κουμπιού με κείμενο και value
		if (item) {
			e.preventDefault();

			const dropdown = item.closest('.dropdown-menu');
			const toggle = dropdown?.previousElementSibling;
			if (toggle) {
				toggle.textContent = item.textContent.trim();
				toggle.setAttribute('data-plan', item.value ?? item.getAttribute('value') ?? '');
			}

			dropdown.classList.remove('show');
			return;
		}

		// CLICK ΕΚΤΟΣ: Κλείσε όλα τα dropdowns
		if (!clickedInsideDropdown) {
			document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
				menu.classList.remove('show');
			});
		}
	});

</script>



