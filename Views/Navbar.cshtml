@using System
@using System.Linq
@using Umbraco.Extensions
@using System.Text.Json
@inject Umbraco.Cms.Core.Security.IMemberManager MemberManager
@inject Umbraco.Cms.Web.Common.UmbracoHelper UmbracoHelper
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    var selection = UmbracoHelper.ContentAtRoot()
        .FirstOrDefault()
        .Children()
        .Where(x => x.IsVisible());

    var currentMember = await MemberManager.GetCurrentMemberAsync();
    var isLoggedIn = Context.User.GetMemberIdentity()?.IsAuthenticated ?? false;

    // âœ… Î Î‘Î¡Î• Ï„Î¿Ï…Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚ Î±Ï€ÏŒ Ï„Î¿ MemberManager (ÏŒÏ‡Î¹ IsInRole)
    var roles = currentMember != null ? await MemberManager.GetRolesAsync(currentMember) : Enumerable.Empty<string>();
    var isCustomer = isLoggedIn && roles.Any(r => r.Equals("Customers", StringComparison.OrdinalIgnoreCase));

    var memberName = currentMember?.Name;
    var displayName = isLoggedIn ? memberName?.Split(" ").FirstOrDefault() : "Î£ÏÎ½Î´ÎµÏƒÎ·";

    // Î‘Î½ Ï„Î¿ node Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Ï€Î¬ÏÎµ Ï„Î¿ URL Ï„Î¿Ï… â€¢ Î±Î»Î»Î¹ÏÏ‚ fallback
    var shoppingCartNode = selection.FirstOrDefault(x => x.Name() == "shoppingcartcontent");
    var shoppingCartUrl  = shoppingCartNode?.Url() ?? "/shoppingcartcontent"; 

    // URLs Î³Î¹Î± logout
    var logoutUrl = Url.Content("~/umbraco/api/member/logout");
    var redirectAfterLogout = Url.Content("~/login"); // Î³ÏÏÎ½Î± ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± login Î¼ÎµÏ„Î¬ Ï„Î¿ logout

    // JSON-safe strings Î³Î¹Î± JS
    var logoutUrlJson = JsonSerializer.Serialize(logoutUrl);
    var redirectAfterLogoutJson = JsonSerializer.Serialize(redirectAfterLogout);
  }

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
      

<nav class="navbar navbar-expand-lg navbar-dark border-0 bg-transparent" role="navigation" aria-label="ÎšÏÏÎ¹Î± Ï€Î»Î¿Î®Î³Î·ÏƒÎ·">
  <div class="nx-container">
    <a href="/" class="nx-brand" aria-label="Î‘ÏÏ‡Î¹ÎºÎ®">
      <img src="~/media/brandlogo.png" alt="Kinsen Hellas Logo" class="navbar-logo" />
    </a>

    <!-- Burger -->
    <button id="nxToggle" class="nx-toggle" type="button"
        aria-controls="nxMenu" aria-expanded="false" aria-label="ÎœÎµÎ½Î¿Ï">
      <i class="fa-solid fa-bars" style="color:#023859;"></i>
    </button>

    <!-- Menu -->
    <div id="nxMenu" class="nx-menu">
      <a href="/" class="nx-brand" aria-label="Î‘ÏÏ‡Î¹ÎºÎ®">
        <img src="~/media/kinsen_vertical.png" alt="Kinsen Hellas Logo" class="navbar-logoInner" style="display:none;"/>
      </a>
      <ul class="nx-left">
        @foreach (var item in selection.Where(x => x.Name() != "Login" && x.Name() != "carDetails" && x.Name() != "carDetailsMember" && x.Name() != "carDetailsVisitor" && x.Name() != "shoppingCartContent" && x.Name() != "Faq" && x.Name() != "userSettings" && x.Name() != "getcode" && x.Name() != "forgotPassword"))
        {
          var menuTitle = item.Value("menuTitle") as string ?? item.Name();
          <li class="nx-li">
              <a class="nx-link"
                href="@item.Url()"
                data-node="@item.Id">
                  @menuTitle
              </a>
          </li>
        }

        <!-- Î— Î•Ï„Î±Î¹ÏÎµÎ¯Î± Î¼Î±Ï‚ (ÎºÏÎ±Ï„Î¬Ï‰ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ¿Ï… custom dropdown) -->
        <li class="nx-li">
          <div class="kx-dropdown">
            <button id="companyDropdown" type="button" class="kx-link"
                    aria-haspopup="true" aria-expanded="false" aria-controls="companyMenu">
              Î— Î•Ï„Î±Î¹ÏÎµÎ¯Î± Î¼Î±Ï‚ <span class="kx-caret" aria-hidden="true"></span>
            </button>
            <ul id="companyMenu" class="kx-menu" role="menu" aria-labelledby="companyDropdown">
              <li role="none"><a role="menuitem" class="kx-menu-item" href="/faq">FAQ</a></li>
            </ul>
          </div>
        </li>
      

      @* <ul class="nx-right"> *@
        @if (isLoggedIn && isCustomer)
        {

          <li class="nx-li">
                <button id="offerCartBtn"
                        class="btn btn-outline-secondary position-relative"
                        type="button"
                        title="ÎšÎ±Î»Î¬Î¸Î¹ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬Ï‚">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span id="offerCartCount"
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
                </button>
          </li>
          <li class="nx-li">
            <div class="kx-user-menu">
              <button
                id="accountBtn"                
                class="kx-btn kx-btn-user"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="accountMenu">
                <i class="fa-solid fa-user"></i>&nbsp;&nbsp;@displayName
                <span class="kx-caret" aria-hidden="true"></span>
              </button>

              <ul id="accountMenu" class="kx-menu" role="menu" aria-labelledby="accountBtn">
                <li role="none"><a role="menuitem" class="kx-menu-item kx-primary" href="/usersettings/" id="settingsBtn"><i class="fa-solid fa-user"></i>&nbsp;Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î ÏÎ¿Ï†Î¯Î»</a></li>
                <li role="none"><a role="menuitem" class="kx-menu-item kx-danger" href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</a></li>
              </ul>
            </div>
          </li>
        }
        else
        {
          <li class="nx-li">
            <a href="/login" class="nx-btn" id="nav-login-btn">
              <i class="fa-solid fa-user"></i>&nbsp;Î£ÏÎ½Î´ÎµÏƒÎ·
            </a>
          </li>
        }
      @* </ul> *@
      </ul>
    </div>
  </div>

  <!-- overlay ÏŒÏ„Î±Î½ Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ burger -->
  <div id="nxOverlay" class="nx-overlay" hidden></div>
</nav>


<script>

// 2) Logout handler (Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿ ÏƒÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±)
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        const response = await fetch(@Html.Raw(logoutUrlJson), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
          window.location.href = @Html.Raw(redirectAfterLogoutJson);
        } else {
          console.error("âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚");
        }
      } catch (error) {
        console.error("âš ï¸ Logout error:", error);
      }
    });
  }
});

// Î‘Ï†Î¿ÏÎ¬ Ï„Î¿ redirect ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹ Ï„Î¿Ï… Ï€ÎµÎ»Î¬Ï„Î·
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("offerCartBtn");
  if (btn)
    btn.addEventListener("click", () => {
      window.location.href = "@shoppingCartUrl";
    });
});

</script>

<script src="~/js/navBar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸ”µ NAVBAR ACTIVE HIGHLIGHT INIT");

  // 1) Î Î¬ÏÎµ Ï„Î¿ NodeId Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î±Ï€ÏŒ Ï„Î¿ HTML tag
  const html = document.documentElement;
  const currentNodeId = html.getAttribute("data-umbraco-page-id");

  console.log("ğŸ” Current Umbraco NodeId =", currentNodeId);

  if (!currentNodeId) {
    console.warn("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ data-umbraco-page-id ÏƒÏ„Î¿ <html>!");
  }

  // 2) Î Î¬ÏÎµ ÏŒÎ»Î± Ï„Î± links Ï„Î¿Ï… main menu Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ data-node
  const links = document.querySelectorAll(".nx-left .nx-link[data-node]");

  console.log("ğŸ” Î’ÏÎ­Î¸Î·ÎºÎ±Î½", links.length, "nav links Î¼Îµ data-node");

  if (!links.length) {
    console.warn("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÎ±Î¸ÏŒÎ»Î¿Ï… .nx-link Î¼Îµ data-node!");
  }

  console.log("ğŸ”µ NAVBAR ACTIVE HIGHLIGHT INIT");

// ... ÎµÎ´Ï Ï€Î±Î¯ÏÎ½ÎµÎ¹Ï‚ currentNodeId & links ...

  links.forEach(link => {
    const linkNodeId = link.getAttribute("data-node");
    const text = link.textContent.trim();

    //console.log(`ğŸ‘‰ Link: "${text}", data-node = ${linkNodeId}`);

    if (linkNodeId === currentNodeId) {
      //console.log(`âœ… MATCH â†’ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· is-active ÏƒÏ„Î¿ "${text}"`);
      link.classList.add("is-active");
    }
  });

    /* â­ Î•Î”Î©: highlight Î³Î¹Î± "Î— Î•Ï„Î±Î¹ÏÎµÎ¯Î± Î¼Î±Ï‚" ÏŒÏ„Î±Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÏ„Î¿ FAQ */
    const companyBtn = document.getElementById("companyDropdown"); // ğŸ”¥ ÎŸÎ§Î™ companyMenu
    const faqNodeId = "1281"; // Ï„Î¿ ID Ï„Î¿Ï… FAQ Î±Ï€ÏŒ Ï„Î¿ Umbraco

    //console.log("ğŸ“Œ currentNodeId =", currentNodeId, "faqNodeId =", faqNodeId);

    if (currentNodeId === faqNodeId && companyBtn) {
      ///console.log('âœ… FAQ MATCH â†’ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· is-active ÏƒÏ„Î¿ "Î— Î•Ï„Î±Î¹ÏÎµÎ¯Î± Î¼Î±Ï‚"');
      companyBtn.classList.add("is-active");
    }
});
</script>
