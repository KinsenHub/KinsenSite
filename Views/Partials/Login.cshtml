    @inject Umbraco.Cms.Core.Security.IMemberManager MemberManager
    @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
    @inject Umbraco.Cms.Core.Security.IMemberManager MemberManager 
    @* είναι η "γέφυρα" για να κάνεις login, logout, να πάρεις τον τρέχοντα χρήστη*@

    @{
        Layout = null;

        // ✅ Correct way to check if a user is logged in
        var member = await MemberManager.GetCurrentMemberAsync(); // Επιστρέφει ένα αντικείμενο Member με το ID, UserName, Email etc του χρήστη.
        var isMemberLoggedIn = member != null;
        System.Diagnostics.Debug.WriteLine(member);
    }

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.11/jquery.validate.unobtrusive.min.js"></script>

    @if (isMemberLoggedIn) //Εάν είναι ήδη συνδεδεμένος, επέστρεψε στην αρχική
    {
        <div class="alert alert-info">Έχετε ήδη συνδεθεί. <a href="/">Επιστροφή στην αρχική</a></div>
    }
    else
    {
        <div class="login-wrapper">
            <div class="login-box">
                @* <img src="~/media/kinsenLogo.png" alt="Kinsen Logo" class="login-logo" /> *@
                <h2 class="login-title">Είσοδος Συνεργάτη</h2>

                <div class="loginForm">

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" autocomplete="username" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Κωδικός</label>
                        <input type="password" id="password" name="password" autocomplete="current-password" class="form-control" required />
                        <button type="button" class="toggle-btn" id="PasswordVisibility">
                            <span class="icon"><i class="fas fa-eye"></i> </span>
                        </button>
                    </div>

                    <div class="mb-3 form-check" style="display:none;">
                        <input type="checkbox" id="rememberMe" class="form-check-input">
                        <label class="form-check-label" for="rememberMe">&nbsp; Να με θυμάσαι</label>
                    </div>

                    <button type="submit" class="btn btn-primary">Σύνδεση</button>
                    <p id="loginMessage" class="mt-2"></p>
                </div>
                 <div class="mt-3 text-center">
                    <a href="/getcode" class="forgot-link" style="color:#007c91;">Ξέχασα τον κωδικό μου</a>
                </div>
            </div>
        </div>
    }

@*-------------------------------------------------*@
<script>
document.addEventListener("DOMContentLoaded", function () {

    const loginBtn = document.querySelector(".btn-primary");

    if (!loginBtn) return;

    loginBtn.addEventListener("click", async function (event) {
        event.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const rememberMe = document.getElementById("rememberMe")?.checked ?? false;

        if (!email || !password) {
            showLoginMessage("Συμπλήρωσε email και κωδικό.", "red");
            return;
        }

        try {
            const response = await fetch("/umbraco/api/member/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include", 
                body: JSON.stringify({ email, password, rememberMe })
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                showLoginMessage(data.message || "Λάθος στοιχεία.", "red");
                return;
            }

            showLoginMessage("Συνδεθήκατε επιτυχώς!", "green", 1500);

            // ⬅️ ΑΦΗΝΟΥΜΕ το Umbraco cookie να κάνει τη δουλειά του
            setTimeout(() => {
                window.location.href = "/home";
            }, 800);

        } catch (err) {
            console.error("Login error:", err);
            showLoginMessage("Σφάλμα κατά τη σύνδεση.", "red");
        }
    });
});

function showLoginMessage(text, color = "red", timeout = 3000) {
    const el = document.getElementById("loginMessage");
    if (!el) return;

    el.textContent = text;
    el.style.color = color;
    el.style.display = "block";

    setTimeout(() => {
        el.textContent = "";
        el.style.display = "none";
    }, timeout);
}

document.addEventListener('DOMContentLoaded', function () {
    const passwordInput = document.getElementById('password');
    const toggleButton = document.getElementById('PasswordVisibility');
    const toggleIcon = toggleButton.querySelector('.icon i');

    // Toggle password visibility
    toggleButton.addEventListener('click', function () {

        const isPassword = passwordInput.type === 'password';

        // Change input type
        passwordInput.type = isPassword ? 'text' : 'password';

        // Change icon
        if (isPassword) {
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
            passwordInput.style="padding: 20px 18px";
        } else {
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    });
});

</script>

